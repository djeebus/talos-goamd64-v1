name: build GOAMD64=v1 version of talos

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        required: true
        description: Talos version

jobs:
  build-release:
    runs-on: ubuntu-22.04

    permissions:
      contents: write
      packages: write

    steps:
      - uses: actions/checkout@v3

      - uses: docker/setup-buildx-action@v2

      - shell: bash
        run: |
          set -e
          set -x
          
          echo "logging into ghcr.io ... "
          echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io --username ${{ github.actor }} --password-stdin  
          
          echo "cloning git repo ... "
          git clone --branch v${{ inputs.version }} --depth 1 https://github.com/siderolabs/talos.git ./talos.git
          cd ./talos.git
          
          echo "building images ... "
          make installer imager talosctl-image talos GOAMD64=v1 REGISTRY=ghcr.io USERNAME=djeebus PUSH=true
          
          echo "building binaries ... "
          make initramfs kernel talosctl GOAMD64=v1

      - uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: "./talos.git/_out/*"
          body: "# v${{ inputs.version }}"
          commit: "main"
          replacesArtifacts: true
          tag: "${{ inputs.version }}"
